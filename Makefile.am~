# the name and executables of the project
bin_SCRIPTS = scripts/wispwot
# the data directory. Users can set this via --prefix: @datarootdir@ = PREFIX/share. See ./configure --help
wispwotdir = @datarootdir@/wispwot
# the data files
nobase_wispwot_DATA =

# where to install guile modules to import
# nobase_ as prefix prevents stripping leading directories
# see https://www.gnu.org/software/automake/manual/html_node/Alternative.html#index-nobase_005f
siteschemedir = $(datarootdir)/guile/site/$(GUILE_EFFECTIVE_VERSION)
nobase_sitescheme_DATA = language/wisp.scm language/wisp/spec.scm
sitewispdir = $(datarootdir)/guile/site/$(GUILE_EFFECTIVE_VERSION)
nobase_sitewisp_DATA = $(wildcard *.w) $(wildcard */*.w)

GOSCMBJECTS = $(nobase_sitescheme_DATA:%.scm=%.go)
nobase_goscm_DATA = $(GOSCMBJECTS)
goscmdir=$(libdir)/guile/$(GUILE_EFFECTIVE_VERSION)/site-ccache

GOWBJECTS = $(nobase_sitewisp_DATA:%.w=%.go)
nobase_gow_DATA = $(GOWBJECTS)
gowdir=$(libdir)/guile/$(GUILE_EFFECTIVE_VERSION)/site-ccache

# Make sure source files are installed first, so that the mtime of
# installed compiled files is greater than that of installed source
# files.  See
# <http://lists.gnu.org/archive/html/guile-devel/2010-07/msg00125.html>
# for details. The missing underscore before DATA is intentional.
guile_install_gow_files = install-nobase_gowDATA
$(guile_install_gow_files): install-nobase_sitewispDATA
guile_install_goscm_files = install-nobase_goscmDATA
$(guile_install_goscm_files): install-nobase_siteschemeDATA


all: $(wispwot) $(nobase_bin_SCRIPTS) ChangeLog AUTHORS  $(nobase_sitewisp_DATA) $(nobase_sitescheme_DATA)

SOURCES =               \
  wispwot/hello.w    \
  run-wispwot.w

EXTRA_DIST =            \
  $(nobase_wispwot_DATA) \
  $(nobase_sitescheme_DATA) \
  AUTHORS.in            \
  README                \
  bootstrap.sh          \
  pre-inst-env.in

CLEANFILES = $(GOSCMBJECTS) $(GOWBJECTS)
DISTCLEANFILES = 
# don't spout out lots of stuff at each distcheck. Disable for debugging.
AM_DISTCHECK_CONFIGURE_FLAGS="--quiet"

# precompile all scheme files
.scm.go:
	$(GUILE_TOOLS) compile -L @abs_top_builddir@ -L @abs_top_srcdir@ $(GUILE_WARNINGS) -o "$@" "$<"
.w.go:
	$(GUILE) -L @abs_top_builddir@ -L @abs_top_srcdir@ -c '(import (language wisp spec))' && $(GUILE_TOOLS) compile -L @abs_top_builddir@ -L @abs_top_srcdir@ -x .w -f wisp $(GUILE_WARNINGS) -o "$@" "$<"
## run-wispwot.w needs cached files from dependencies that do not get created by guild, so we import from guile once
run-wispwot.go : run-wispwot.w
	$(GUILE) -L @abs_top_builddir@ -L @abs_top_srcdir@ -c '(import (language wisp spec))' && $(GUILE) -L @abs_top_builddir@ -L @abs_top_srcdir@ --language=wisp -x .w -c 'import : run-wispwot' && $(GUILE_TOOLS) compile -L @abs_top_builddir@ -L @abs_top_srcdir@ -x .w -f wisp $(GUILE_WARNINGS) -o "$@" "$<"
language/wisp/spec.go: language/wisp/spec.scm language/wisp.go 

ACLOCAL_AMFLAGS = -I m4


# pseudo-lines to show help output for install, because the guile build setup requires leaving install and uninstall unchanged
#install: ## install to locations defined by ./configure
#uninstall: ## remove the installed files
